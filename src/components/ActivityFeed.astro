---

import { db, comments, reactions } from 'astro:db';
import { getSanityPosts } from '../utils/getSanityPosts';

type CommentActivity = {
  type: 'comment';
  name: string;
  postId: string;
  date: Date;
  preview: string;
};

type ReactionActivity = {
  type: 'reaction';
  postId: string;
  date: Date;
  emoji: string;
};

type Activity = CommentActivity | ReactionActivity;

const posts = await getSanityPosts();
const postMap = Object.fromEntries(posts.map((p: any) => [p._id, p]));


const recentComments = (await db.select().from(comments))
  .filter(c => c.approved)
  .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
  .slice(0, 5);


const recentReactions = (await db.select().from(reactions))
  .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
  .slice(0, 5);


const activities: Activity[] = [
  ...recentComments.map(c => ({
    type: 'comment' as const,
    name: c.name,
    postId: c.postId,
    date: c.createdAt,
    preview: c.content.substring(0, 50) + (c.content.length > 50 ? '...' : '')
  })),
  ...recentReactions.map(r => ({
    type: 'reaction' as const,
    postId: r.postId,
    date: r.createdAt,
    emoji: r.emoji
  }))
]
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
  .slice(0, 8);
---

<div class="activity-feed">
  <h3>activity</h3>
  <div class="activities">
    {activities.length > 0 ? (
      activities.map(activity => {
        const post = postMap[activity.postId];
        return (
          <div class="activity-item  hover:bg-gray-800 mt-4">
            {activity.type === 'comment' ? (
              <>
                <div class="activity-icon comment-icon">ðŸ’¬</div>
                <div class="activity-content">
                  <div class="activity-title">
                    <span class="activity-name">{activity.type === 'comment' && activity.name}</span>
                    <span class="activity-action">commented</span>
                  </div>
                  <p class="activity-preview">{activity.type === 'comment' && activity.preview}</p>
                  {post && (
                    <a href={`/notes/${post.slug.current}`} class="activity-post">
                      on "{post.title}"
                    </a>
                  )}
                </div>
              </>
            ) : (
              <>
                <div class="activity-icon reaction-icon">{activity.type === 'reaction' && activity.emoji}</div>
                <div class="activity-content">
                  <div class="activity-action ">reacted</div>
                  {post && (
                    <a href={`/notes/${post.slug.current}`} class="activity-post">
                      to "{post.title}"
                    </a>
                  )}
                </div>
              </>
            )}
            <div class="activity-time">
              {new Date(activity.date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
              })}
            </div>
          </div>
        );
      })
    ) : (
      <div class="empty-activity">no activity yet</div>
    )}
  </div>
</div>

<style>
  .activity-feed {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 2rem 0;
  }

  .activity-feed h3 {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.9rem;
    font-weight: 500;
    color: #c8ccda;
    margin: 0 0 1.5rem 0;
    text-transform: lowercase;
  }

  .activities {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .activity-item {
    display: flex;
    gap: 1rem;
    padding: 0.75rem;
    background: #0f0f0f;
    border-radius: 6px;
    border-left: 2px solid transparent;
    transition: all 0.2s ease;
  }

  .activity-item:hover {
    background: #141414;
    border-left-color: #c8ccda;
  }

  .activity-icon {
    font-size: 1.25rem;
    min-width: 32px;
    text-align: center;
  }

  .activity-content {
    flex: 1;
    min-width: 0;
  }

  .activity-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
    color: #c8ccda;
    margin-bottom: 0.25rem;
  }

  .activity-name {
    font-weight: 500;
    color: #c8ccda;
  }

  .activity-action {
    color: #666;
    font-size: 0.75rem;
  }

  .activity-preview {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    color: #999;
    margin: 0.25rem 0 0.5rem 0;
    line-height: 1.4;
  }

  .activity-post {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    color: #666;
    text-decoration: none;
    transition: color 0.2s;
    display: inline-block;
  }

  .activity-post:hover {
    color: #c8ccda;
  }

  .activity-time {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    color: #444;
  }

  .empty-activity {
    text-align: center;
    color: #555;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
    padding: 2rem 1rem;
  }
</style>
